---
title: ' Network di Bigrammi (Ger - Fra)'
runtime: shiny
output:
  html_document:
    css: css/skeleton.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      message = FALSE, 
                      warning = FALSE)

library(tidyverse, warn.conflicts = F, quietly = T)
library(glue, warn.conflicts = F, quietly = T)
library(shiny, warn.conflicts = F, quietly = T)
library(tidytext, warn.conflicts = F, quietly = T)
library(pdftools, warn.conflicts = F, quietly = T)
library(purrrlyr, warn.conflicts = F, quietly = T)
library(forcats, warn.conflicts = F, quietly = T)
library(topicmodels, warn.conflicts = F, quietly = T)
library(htmlwidgets, warn.conflicts = F, quietly = T)
library(ggraph, warn.conflicts = F, quietly = T)
library(igraph, warn.conflicts = F, quietly = T)
library(reactable, warn.conflicts = F, quietly = T)
library(stopwords, warn.conflicts = F, quietly = T)
library(rdrop2, quietly = T, warn.conflicts = F)


# importedFrom rdrop2
get_dropbox_token <- function() {
  
  if (!exists('.dstate') || is.null(.dstate$token)) {
    drop_auth()
  } else {
    .dstate$token
  }
}


# mod from rdrop2
drop_read_pdf =function (country_name, dest = tempdir(), dtoken = get_dropbox_token(),...){
  
  output_dir <- "PNRR"
  file_info <- drop_dir(output_dir)
  
  if(!(country_name %in% file_info$name)){
    stop(glue("il nome della nazione {country_name} non è nella cartella Dropbox, hai per caso sbagliato a digitare il nome? (scrivilo in italiano ITA)"))
  }
  
  
  file_path <- file_info %>%
    dplyr::filter(name == country_name) %>%
    select(path_display) %>% 
    pull()
  
  localfile = glue("{dest}/{basename(file_path)}")
  
  drop_download(file_path, localfile, overwrite = TRUE, dtoken = dtoken)
  
  pdftools::pdf_text(localfile, ...)
}

# 
# francia = drop_read_pdf("francia.pdf") %>% 
#   readr::read_lines() %>%  
#   str_squish() %>% 
#   as_tibble() %>% 
#   mutate(paese= forcats::as_factor("francia")) %>% 
#   rename(text = value)
# 
# 
# germania = drop_read_pdf("germania.pdf") %>% 
#   readr::read_lines() %>%  
#   str_squish() %>% 
#   as_tibble() %>% 
#   mutate(paese= forcats::as_factor("germania")) %>% 
#   rename(text = value)

## drake task
francia = pdf_text("data/francia.pdf") %>%
  readr::read_lines() %>%
  str_squish() %>%
  as_tibble() %>%
  mutate(paese= forcats::as_factor("francia")) %>%
  rename(text = value)

germania = pdf_text("data/germania.pdf") %>%
  readr::read_lines() %>%
   str_squish() %>%
  as_tibble() %>%
  mutate(paese= forcats::as_factor("germania")) %>%
  rename(text = value)

both_pnr = bind_rows(francia,germania)
```

<img src="img/officine_italia.png" align="right" height="60" />
_last build date_: `r format(Sys.Date(), "%d %B, %Y")`

**GOAL**: Esploriamo le relazioni tra Bigrammi, magari vengono fuori dei clusters di parole che ci aiutano a vedere dei possibili topics. Un altro impiego è capire con un colpo d'occhio di che cosa parla il documento.

**Documentazione**: Il filtro permette di tenere nel grafico solo i brigrammi il cui conto è maggiore del numero espresso. Infatti all'aumentare del filtro, diminuiscono i nodi del network.


```{r bigramsnet}

arreter_mots = get_stopwords("fr") 

country <- c("francia", "germania")


inputPanel(
  
  numericInput("filter", "Filtra il n° dei Bigrammi", 5, min = 1, max = 100),
  
  selectInput("country", label = "Seleziona Paese", choices = country,
              selected = country[2])
)



ger_bigram =  reactive({  both_pnr %>%
    dplyr::filter(paese == input$country) %>% 
    unnest_tokens(bigram, text, token = "ngrams", n = 2) 

})


bigrams_separated_ger <-reactive({   
  ger_bigram() %>%
  separate(bigram, c("word1", "word2"), sep = " ")
})

bigrams_filtered <-reactive({   
  bigrams_separated_ger() %>%
    filter(!word1 %in% stop_words$word) %>%
    filter(!word2 %in% stop_words$word) %>%
    filter(!word1 %in% arreter_mots$word) %>%
    filter(!word2 %in% arreter_mots$word)
  
})

# new bigram counts:
bigram_counts <- reactive({  
  bigrams_filtered() %>% 
  count(word1, word2, sort = TRUE)

})

bigrams_united <- reactive({
  bigrams_filtered() %>%
    select(-paese) %>% 
    unite(bigram, sep = " ") %>%
    count(bigram, sort = TRUE)
})


set.seed(2021)

bigram_graph <- reactive({   
  bigram_counts() %>%
  filter(n > input$filter) %>%
  graph_from_data_frame()

})

# 
# DT::renderDataTable({
#     DT::datatable(bigrams_united(),
#                   rownames = FALSE,
#                   options = list(
#     lengthChange = FALSE,
#     initComplete = JS(
#       "function(settings, json) {",
#       "$(this.api().table().header()).css({'background-color': '#42f', 'color': '#fff'});",
#       "}"),
#     autowidth = TRUE,
#     language = list(url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/Italian.json'),
#     columnDefs = list(list(width = '70%', targets = 1))
#     )
#     ) %>% 
#     DT::formatPercentage('beta', 2)  %>% 
#     DT::formatStyle('beta', fontWeight = DT::styleInterval(1, c('normal', 'bold'))) 
# })



renderReactable({
      
  bigrams_united() %>% 
    reactable(searchable = TRUE,
            minRows = 8,
            theme = reactableTheme(
    borderColor = "#1c5253",
    stripedColor = "#1c5253",
    highlightColor = "#1c5253",
    cellPadding = "8px 12px",
    style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif"),
    searchInputStyle = list(width = "100%")
  ))
})

renderPlot({
    
  
  a = grid::arrow(type = "closed", length = unit(.15, "inches"))
  
  ggraph(bigram_graph(), layout = "fr") +
    geom_edge_link(aes(edge_alpha = n), show.legend = FALSE,
                   arrow = a, end_cap = circle(.07, 'inches')) +
    geom_node_point(color = "lightblue", size = 5) +
    geom_node_text(aes(label = name), vjust = 1, hjust = 1) +
    theme_void()
# 
#     theme(axis.text.x = element_text(angle = 25, vjust = 0.5, hjust=1),
#           plot.background = ggplot2::element_blank(),
#           panel.background = ggplot2::element_blank()
#           )

})

```

